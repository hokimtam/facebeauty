<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smile Detection with OpenCV.js</title>
</head>
<body>
    <h2>Upload an Image to Detect Smiles</h2>
    <input type="file" id="fileInput" accept="image/*">
    <canvas id="canvasOutput"></canvas>
    <p id="status">Loading OpenCV.js...</p>

    <!-- Load OpenCV.js -->
    <script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvLoaded()"></script>

    <script>
        let faceCascade, smileCascade;
        let isOpenCVReady = false;

        function onOpenCvLoaded() {
            console.log("âœ… OpenCV.js is loaded!");
            document.getElementById("status").innerText = "Initializing OpenCV...", cv;

            cv['onRuntimeInitialized'] = function () {
                console.log("âœ… OpenCV runtime initialized!");
                faceCascade = new cv.CascadeClassifier();
                smileCascade = new cv.CascadeClassifier();

                let faceCascadeFile = "haarcascade_frontalface_default.xml";
                let smileCascadeFile = "haarcascade_smile.xml";

                let loadedFiles = 0;
                function checkAllFilesLoaded() {
                    loadedFiles++;
                    if (loadedFiles === 2) {
                        isOpenCVReady = true;
                        document.getElementById("status").innerText = "OpenCV is Ready! Upload an image.";
                        console.log("âœ… All cascade files loaded. Ready to detect!");
                    }
                }

                loadCascadeFile(faceCascadeFile, faceCascade, checkAllFilesLoaded);
                loadCascadeFile(smileCascadeFile, smileCascade, checkAllFilesLoaded);
            };
        }

        function loadCascadeFile(fileName, cascade, callback) {
            let utils = new cv.Utils();
            utils.createFileFromUrl(fileName, fileName, function () {
                cascade.load(fileName);
                console.log(`âœ… Loaded: ${fileName}`);
                callback();
            });
        }

        document.getElementById('fileInput').addEventListener('change', (event) => {
            if (!isOpenCVReady) {
                alert("OpenCV is still loading. Please wait...");
                return;
            }

            let file = event.target.files[0];
            if (!file) return;

            let img = new Image();
            img.src = URL.createObjectURL(file);
            img.onload = function () {
                let canvas = document.getElementById('canvasOutput');
                let ctx = canvas.getContext('2d');
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0, img.width, img.height);

                let src = cv.imread(canvas);
                let gray = new cv.Mat();
                cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

                let faces = new cv.RectVector();
                let smiles = new cv.RectVector();

                faceCascade.detectMultiScale(gray, faces, 1.1, 3, 0);
                console.log(`ðŸŸ¢ Detected Faces: ${faces.size()}`);

                for (let i = 0; i < faces.size(); ++i) {
                    let roiGray = gray.roi(faces.get(i));
                    smileCascade.detectMultiScale(roiGray, smiles, 1.8, 50, 0);
                    
                    console.log(`ðŸŸ¢ Detected Smiles: ${smiles.size()}`);

                    for (let j = 0; j < smiles.size(); ++j) {
                        let smile = smiles.get(j);
                        let smileRatio = (smile.width * smile.height) / (faces.get(i).width * faces.get(i).height);
                        let smileIntensity = Math.min(100, Math.round(smileRatio * 500));

                        let smileCategory = "No Smile";
                        if (smileIntensity > 20) smileCategory = "Mild Smile";
                        if (smileIntensity > 40) smileCategory = "Grin";
                        if (smileIntensity > 60) smileCategory = "Big Smile";
                        if (smileIntensity > 80) smileCategory = "Laughing";

                        console.log(`ðŸ˜€ Smile Intensity: ${smileIntensity}% - ${smileCategory}`);

                        ctx.strokeStyle = "blue";
                        ctx.lineWidth = 2;
                        ctx.strokeRect(faces.get(i).x + smile.x, faces.get(i).y + smile.y, smile.width, smile.height);
                    }
                    roiGray.delete();
                }

                src.delete();
                gray.delete();
                faces.delete();
                smiles.delete();
            };
        });

    </script>
</body>
</html>
