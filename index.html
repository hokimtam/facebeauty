<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Beautify with OpenCV.js</title>
    <script src="js/opencv.js" onload="onOpenCvReady();"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
        }

        input,
        button {
            margin: 10px;
            padding: 8px 12px;
            font-size: 16px;
        }

        canvas {
            margin-top: 10px;
            border: 1px solid #ccc;
        }
    </style>
</head>

<body>

    <h2>Face Beautify with OpenCV.js</h2>
    <input type="file" id="upload" accept="image/*">
    <br>
    <canvas id="canvas"></canvas>
    <br>
    <button onclick="processImageWithRetry()">Apply Beautify Filter</button>

    <script>
        let img = new Image();
        let canvas = document.getElementById("canvas");
        let ctx = canvas.getContext("2d");
        let imageLoaded = false;

        function onOpenCvReady() {
            if (cv && cv.getBuildInformation) {
                console.log("✅ OpenCV.js is fully loaded!");
                console.log(cv.getBuildInformation());
            } else {
                console.error("❌ OpenCV.js failed to load.");
            }
        }

        document.getElementById("upload").addEventListener("change", function (event) {
            let file = event.target.files[0];
            if (file) {
                let reader = new FileReader();
                reader.onload = function (e) {
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        img.onload = function () {
            canvas.width = img.width / 2;
            canvas.height = img.height / 2;
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            imageLoaded = true;
        };

        function waitForOpenCV(callback) {
            if (typeof cv !== 'undefined' && cv.getBuildInformation) {
                console.log("✅ OpenCV.js is ready!");
                callback();
            } else {
                console.log("⏳ Waiting for OpenCV.js...");
                setTimeout(() => waitForOpenCV(callback), 500);
            }
        }

        function processImageWithRetry() {
            if (!imageLoaded) {
                alert("Please upload an image first!");
                return;
            }
            waitForOpenCV(processImage);
        }

        function processImage() {
            if (typeof cv === 'undefined' || !cv.imread) {
                alert("❌ OpenCV.js is not loaded. Check if the script path is correct!");
                return;
            }

            let src = cv.imread(canvas);

            if (src.empty()) {
                alert("❌ Failed to read image from canvas. Try re-uploading.");
                return;
            }

            // Ensure image is CV_8UC3 format
            let dst = new cv.Mat();
            if (src.type() !== cv.CV_8UC3) {
                cv.cvtColor(src, dst, cv.COLOR_RGBA2RGB);
            } else {
                dst = src.clone();
            }

            // Apply Bilateral Filter for skin smoothing (tuned parameters)
            let smooth = new cv.Mat();
            cv.bilateralFilter(dst, smooth, 10, 50, 50, cv.BORDER_DEFAULT);

            // Convert to LAB color space for better skin lightening
            let lab = new cv.Mat();
            cv.cvtColor(smooth, lab, cv.COLOR_RGB2Lab);

            let labChannels = new cv.MatVector();
            cv.split(lab, labChannels);

            // Adjust only the L channel (brightness)
            let lChannel = labChannels.get(0);
            lChannel.convertTo(lChannel, -1, 1.05, 5);

            // Merge LAB channels back and convert to RGB
            labChannels.set(0, lChannel);
            cv.merge(labChannels, lab);
            cv.cvtColor(lab, smooth, cv.COLOR_Lab2RGB);

            // Blend with the original image to keep details
            let finalOutput = new cv.Mat();
            cv.addWeighted(smooth, 0.7, dst, 0.3, 0, finalOutput);

            // Display final result
            cv.imshow("canvas", finalOutput);

            // Free memory
            src.delete(); dst.delete(); smooth.delete(); lab.delete(); labChannels.delete();
            lChannel.delete(); finalOutput.delete();
        }

    </script>

</body>

</html>